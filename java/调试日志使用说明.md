# 调试日志使用说明

## 概述

游戏黑屏问题调试日志系统已经集成到项目中。本系统支持TAG过滤、日志导出和详细的黑屏问题诊断。

## 快速开始

### 1. 设置TAG过滤（推荐）

在浏览器控制台中，设置要记录的日志TAG：

```javascript
// 方式1：使用预设的TAG组合（推荐）
window.DEBUG_TAGS = window.DEBUG_PRESETS.BLACKSCREEN;
// 这会记录：BLACKSCREEN, SWAPBUFFERS, REFRESH0, DRAWIMAGE2, WEBGL, SHADER

// 方式2：自定义TAG列表
window.DEBUG_TAGS = ['BLACKSCREEN', 'SWAPBUFFERS', 'DRAWIMAGE2', 'REFRESH0'];

// 方式3：记录所有日志（不推荐，会产生大量日志）
window.DEBUG_TAGS = [];
```

### 2. 运行游戏

启动游戏，让黑屏问题重现。日志会自动记录到内存中。

### 3. 查看和导出日志

```javascript
// 查看所有日志（文本格式）
console.log(window.getDebugLogsText());

// 查看特定TAG的日志
console.log(window.getDebugLogsText(['BLACKSCREEN', 'SWAPBUFFERS']));

// 复制日志到剪贴板（推荐）
window.copyDebugLogs();

// 导出日志到文件
window.exportDebugLogs();

// 查看日志统计
window.showDebugLogStats();
```

## 可用的TAG列表

### 黑屏相关TAG

- **BLACKSCREEN**: 检测到黑色像素时的警告
- **SWAPBUFFERS**: swapBuffers相关操作
- **DRAWIMAGE2**: drawImage2绘制操作
- **REFRESH0**: refresh0屏幕刷新操作
- **WEBGL**: WebGL渲染操作（drawElements, drawArrays, clear等）
- **SHADER**: 着色器相关操作

### 预设TAG组合

```javascript
// 黑屏问题诊断（推荐）
window.DEBUG_TAGS = window.DEBUG_PRESETS.BLACKSCREEN;

// 渲染流程诊断
window.DEBUG_TAGS = window.DEBUG_PRESETS.RENDERING;

// WebGL相关
window.DEBUG_TAGS = window.DEBUG_PRESETS.WEBGL;

// 所有日志
window.DEBUG_TAGS = window.DEBUG_PRESETS.ALL;
```

## 详细使用步骤

### 步骤1：打开浏览器控制台

1. 按 `F12` 打开开发者工具
2. 切换到 `Console` 标签

### 步骤2：设置TAG过滤

在控制台输入：

```javascript
// 设置黑屏相关日志
window.DEBUG_TAGS = window.DEBUG_PRESETS.BLACKSCREEN;
```

### 步骤3：清除旧日志（可选）

```javascript
window.clearDebugLogs();
```

### 步骤4：运行游戏

1. 启动游戏
2. 等待黑屏问题出现
3. 让游戏运行几秒钟以收集足够的日志

### 步骤5：复制日志

在控制台输入：

```javascript
// 复制所有日志到剪贴板
window.copyDebugLogs();

// 或者只复制特定TAG的日志
window.copyDebugLogs(['BLACKSCREEN', 'SWAPBUFFERS']);
```

然后粘贴到文本编辑器或发送给开发者。

### 步骤6：查看日志统计（可选）

```javascript
// 查看日志统计信息
window.showDebugLogStats();
```

这会显示：
- 每个TAG的日志数量
- 日志级别分布（DEBUG, INFO, WARN, ERROR）
- 总日志数
- 当前过滤的TAG

## 日志内容说明

### BLACKSCREEN TAG

当检测到黑色像素时会记录：

```javascript
{
  tag: 'BLACKSCREEN',
  level: 'WARN',
  message: 'Device canvas center pixel is BLACK!',
  data: {
    pixel: { r: 0, g: 0, b: 0, a: 255 },
    sourceCenterPixel: { r: 128, g: 128, b: 128, a: 255 },
    size: '240x320'
  }
}
```

### SWAPBUFFERS TAG

记录swapBuffers操作：

```javascript
{
  tag: 'SWAPBUFFERS',
  level: 'DEBUG',
  message: 'readPixels called',
  data: {
    x: 0, y: 0,
    width: 240, height: 320,
    canvasSize: '240x320',
    bufferSize: 307200
  }
}
```

### DRAWIMAGE2 TAG

记录drawImage2绘制操作：

```javascript
{
  tag: 'DRAWIMAGE2',
  level: 'INFO',
  message: 'putImageData to DEVICE canvas completed',
  data: {
    size: '240x320',
    centerPixel: { r: 128, g: 128, b: 128, a: 255 }
  }
}
```

### WEBGL TAG

记录WebGL渲染操作：

```javascript
{
  tag: 'WEBGL',
  level: 'DEBUG',
  message: 'drawElements',
  data: {
    mode: 4,
    count: 36,
    type: 5123,
    offset: 0,
    hasProgram: true,
    viewport: [0, 0, 240, 320],
    hasElementBuffer: true,
    hasArrayBuffer: true
  }
}
```

## 常见问题诊断

### 问题1：WebGL读取的像素是黑色

如果日志显示 `BLACKSCREEN` 警告，且 `WebGL readPixels center pixel is BLACK!`，说明：
- WebGL渲染可能失败
- 着色器可能输出黑色
- 顶点可能不在视锥体内
- 深度测试可能失败

### 问题2：Device canvas像素是黑色

如果日志显示 `Device canvas center pixel is BLACK after refresh0 copy!`，说明：
- drawImage2可能没有正确写入device canvas
- refresh0可能覆盖了3D内容

### 问题3：没有drawElements调用

如果日志中没有 `WEBGL` 的 `drawElements` 记录，说明：
- 游戏可能没有调用渲染命令
- 渲染流程可能中断

## 高级用法

### 禁用日志记录

```javascript
window.DEBUG_ENABLED = false;
```

### 启用日志记录

```javascript
window.DEBUG_ENABLED = true;
```

### 调整最大日志数量

```javascript
window._maxLogSize = 20000; // 默认10000
```

### 实时监控日志

```javascript
// 每5秒输出一次日志统计
setInterval(() => {
  window.showDebugLogStats();
}, 5000);
```

## 导出日志给开发者

1. 设置TAG过滤：
   ```javascript
   window.DEBUG_TAGS = window.DEBUG_PRESETS.BLACKSCREEN;
   ```

2. 运行游戏，重现黑屏问题

3. 复制日志：
   ```javascript
   window.copyDebugLogs();
   ```

4. 将复制的日志内容发送给开发者

或者：

1. 导出日志文件：
   ```javascript
   window.exportDebugLogs();
   ```

2. 将下载的日志文件发送给开发者

## 注意事项

1. **日志数量**：默认最多保存10000条日志，超过会自动删除最旧的日志
2. **性能影响**：启用日志记录会有轻微的性能影响，建议只在调试时启用
3. **TAG过滤**：设置TAG过滤可以大幅减少日志数量，提高性能
4. **节流机制**：某些高频操作（如drawElements）的日志会被节流，避免日志过多

## 示例：完整调试流程

```javascript
// 1. 设置TAG过滤
window.DEBUG_TAGS = window.DEBUG_PRESETS.BLACKSCREEN;

// 2. 清除旧日志
window.clearDebugLogs();

// 3. 运行游戏（在浏览器中操作）

// 4. 等待几秒后，查看统计
window.showDebugLogStats();

// 5. 复制日志
window.copyDebugLogs();

// 6. 将日志粘贴到文本编辑器，发送给开发者
```

## 技术支持

如果遇到问题，请提供：
1. 浏览器类型和版本
2. 游戏名称
3. 完整的日志内容
4. 问题描述

---

**最后更新**：2025年12月12日
